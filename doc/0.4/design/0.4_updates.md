# Amber 0.4 Design Updates

Amber v0.4 is the first release that pairs the capability-aware ISA from v0.3 with an aggressive out-of-order core and a coherent dual-core fabric. The design work for this release focused on closing outstanding architectural gaps (prefix selection, 128-bit atomics) while ensuring the deeper pipeline never violates capability semantics.

## Microarchitecture Highlights

- Eleven-stage pipeline with clustered issue, 160-entry ROB, and decoupled capability check unit; see `0.4_microarchitecture.md` for full details.
- Dual-bundle fetch with hybrid TAGE/loop prediction and fast recovery paths to mitigate the longer pipeline flush cost.
- Capability-aware load/store queue keeps tag, bounds, and loan metadata alongside address and data, enabling speculative capability use without lost authority.
- Shared 256 KB victim/tagged cache slice provides inclusive visibility for both cores while respecting capability tags and LOAN/TRACE extensions.

## ISA and Capability Additions

- Short-form capability prefix instructions let compact code pick any GC register as the base without switching to 24-bit encodings.
- Saturating ALU operations, byte-level short-form loads/stores, and branch predictor hints expand the 12-bit space; packed arithmetic and 128-bit atomics land in the 24-bit class.
- New capability permissions (TRACE, LOAN), loan-management instructions, and prefix state tracking integrate with the ISA so software can explicitly cooperate with the expanded microarchitecture.
- CSR map grows to cover prefix/loan/speculation telemetry while keeping indices stable for existing tooling.

## Toolchain and Ecosystem

- Assembler/disassembler accept `--enable-v0.4` to unlock new mnemonics and recover prefix windows in listings. Legacy code assembles unchanged unless the new flag is present.
- RTL configuration scripts expose parameters for physical register counts, queue depths, cache sizing, and per-core MSHR quotas to ease FPGA floorplanning.
- Debug infrastructure samples per-cluster occupancy, prefix window depth, and capability fault metadata, enabling cycle-accurate tracing on the Arora-V evaluation board.

## Compatibility and Migration

- v0.3 binaries run without modification. Prefix defaults ensure short-form memory still uses GC0 when no prefix executes.
- 128-bit LR/SC and capability loan instructions are additive: existing code that relies on 64-bit atomics or simple delegation semantics continues to behave as before.
- Deferred features called out in `0.3_isa.md` are now addressed except for the full transactional-memory proposal, which remains under evaluation.

## Open Follow-Ups

- Finalize transactional-memory semantics built on top of the new speculation and capability rollback plumbing.
- Evaluate the cost/benefit of exposing vector-friendly 48-bit encodings before committing to silicon.
- Continue timing closure exploration for four-cluster variants that push beyond the Arora-V 138K fabric.
